name: Ingress Deployment

on:
  push:
    branches: [ "main" ]
    paths: [ "bicep/**" ]
  pull_request:
    branches: [ "main" ]

env:
  LOCATION: westus
  BOOTSTRAP_TEMPLATE_FILE: ./bicep/bootstrap/main.bicep
  SERVICES_TEMPLATE_FILE: ./bicep/services/main.bicep
  PARAMETERS_TEMPLATE: ./bicep/templates/parameters.json.j2
  PARAMETERS_OUTPUT: parameters.json

jobs:
  deploy:
    permissions:
      id-token: write # require write permission to fetch an OIDC token

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch Secrets
        id: secrets # set an id so we can access the output
        uses: bitwarden/sm-action@v3.0.0-beta.3
        with:
          access_token: ${{ secrets.BITWARDEN_ACCESS_TOKEN }}
          set_env: false # do not set secrets as env vars
          secrets: |
            a2e022b2-6efc-4376-aff6-b3bb0148e797 > AZURE_CLIENT_ID
            af08df26-6767-4b62-ba8e-b3bb01492f1f > AZURE_TENANT_ID
            4b6aeda8-517b-482c-a290-b3bb0149ec82 > AZURE_SUBSCRIPTION_ID
            357e0951-4bba-47a9-9e48-b3bd0024684b > TEMP_VM_ADMIN_PASSWORD

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ steps.secrets.outputs.AZURE_CLIENT_ID }}
          tenant-id: ${{ steps.secrets.outputs.AZURE_TENANT_ID }}
          subscription-id: ${{ steps.secrets.outputs.AZURE_SUBSCRIPTION_ID }}

      - name: Render Deployment Parameters
        uses: cuchi/jinja2-action@v1.3.0
        with:
          template: ${{ env.PARAMETERS_TEMPLATE }}
          output_file: ${{ env.PARAMETERS_OUTPUT }}
        env:
          LOCATION: ${{ env.LOCATION }}
          TEMP_VM_ADMIN_PASSWORD: ${{ steps.secrets.outputs.TEMP_VM_ADMIN_PASSWORD }}

      - name: Dry Run
        if: github.event_name == 'pull_request'
        run: |
          az deployment sub what-if \
            --location "${{env.LOCATION}}" \
            --template-file "${{ env.BOOTSTRAP_TEMPLATE_FILE }}" \
            --parameters @${{ env.PARAMETERS_OUTPUT }}
          az deployment sub what-if \
            --location "${{env.LOCATION}}" \
            --template-file "${{ env.SERVICES_TEMPLATE_FILE }}" \
            --parameters @${{ env.PARAMETERS_OUTPUT }}

      - name: Deployment
        if: github.event_name == 'push'
        run: |
          az deployment sub create \
            --location "${{env.LOCATION}}" \
            --template-file "${{ env.BOOTSTRAP_TEMPLATE_FILE }}" \
            --parameters @${{ env.PARAMETERS_OUTPUT }}
          az deployment sub create \
            --location "${{env.LOCATION}}" \
            --template-file "${{ env.SERVICES_TEMPLATE_FILE }}" \
            --parameters @${{ env.PARAMETERS_OUTPUT }}
