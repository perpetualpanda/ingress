#cloud-config
---
ssh_pwauth: false

apt:
  sources:
    tailscale.list:
      source: "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/tailscale.gpg] https://pkgs.tailscale.com/stable/ubuntu ${RELEASE} main"
      keyid: 2596A99EAAB33821893C0A79458CA832957F5868
      keyring: /etc/apt/keyrings/tailscale.gpg
    docker.list:
      source: "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${RELEASE} stable"
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
      keyring: /etc/apt/keyrings/docker.gpg

package_update: true
package_upgrade: true
packages:
  - docker-ce
  - docker-ce-cli
  - tailscale

users:
  - name: ppanda
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - {{ SSH_PUBLIC_KEY }}

groups:
  - docker

system_info:
  default_user:
    groups: [ sudo, docker ]

systemd:
  units:
    - name: docker.service
      enabled: true
      state: started

sysctl:
  # configure ip forwarding for tailscale
  net.ipv4.ip_forward: 1
  net.ipv6.conf.all.forwarding: 1

runcmd:
  # initialize and authenticate tailscale
  - tailscale up --auth-key={{ TS_OAUTH_SECRET }}?ephemeral=false&preauthorized=true --advertise-tags=tag:reverse-proxy --ssh --advertise-exit-node

final_message: "system is up, after $UPTIME seconds"
